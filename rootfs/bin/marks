#!/bin/bash
# marks - Bookmark system for DumpsterOS
# Quick navigation to your favorite trash piles

MARKS_FILE="/root/.marks"
touch "$MARKS_FILE"

# Colors
GREEN='\033[1;92m'
YELLOW='\033[1;33m'
PINK='\033[1;35m'
GRAY='\033[90m'
RED='\033[1;31m'
RST='\033[0m'

show_help() {
    echo -e "${PINK}marks${RST} - Bookmark Manager"
    echo ""
    echo "Usage:"
    echo -e "  ${GREEN}marks add <name> [path]${RST}    Add bookmark (uses current dir if no path)"
    echo -e "  ${GREEN}marks go <name>${RST}            Navigate to bookmark"
    echo -e "  ${GREEN}marks list${RST}                 List all bookmarks"
    echo -e "  ${GREEN}marks remove <name>${RST}        Remove bookmark"
    echo -e "  ${GREEN}marks help${RST}                 Show this help"
    echo ""
    echo "Examples:"
    echo "  marks add home /root"
    echo "  marks add here"
    echo "  marks go home"
}

add_mark() {
    local name="$1"
    local path="${2:-$(pwd)}"
    
    if [ -z "$name" ]; then
        echo -e "${RED}Error:${RST} Mark name required"
        return 1
    fi
    
    # Resolve to absolute path
    path=$(realpath "$path" 2>/dev/null)
    
    if [ ! -d "$path" ]; then
        echo -e "${RED}Error:${RST} Directory does not exist: $path"
        return 1
    fi
    
    # Remove existing mark with same name
    sed -i "/^${name}:/d" "$MARKS_FILE"
    
    # Add new mark
    echo "${name}:${path}" >> "$MARKS_FILE"
    echo -e "${GREEN}✓${RST} Bookmarked: ${YELLOW}${name}${RST} → ${path}"
}

go_mark() {
    local name="$1"
    
    if [ -z "$name" ]; then
        echo -e "${RED}Error:${RST} Mark name required"
        return 1
    fi
    
    local path=$(grep "^${name}:" "$MARKS_FILE" | cut -d: -f2-)
    
    if [ -z "$path" ]; then
        echo -e "${RED}Error:${RST} Mark not found: ${name}"
        echo "Use 'marks list' to see available marks"
        return 1
    fi
    
    if [ ! -d "$path" ]; then
        echo -e "${RED}Error:${RST} Directory no longer exists: ${path}"
        echo "Consider removing this mark with: marks remove ${name}"
        return 1
    fi
    
    cd "$path" || return 1
    echo -e "${GREEN}→${RST} Jumped to: ${YELLOW}${name}${RST} (${path})"
}

list_marks() {
    if [ ! -s "$MARKS_FILE" ]; then
        echo -e "${GRAY}No bookmarks yet${RST}"
        echo "Add one with: marks add <name>"
        return
    fi
    
    echo -e "${PINK}Bookmarks:${RST}"
    echo ""
    
    while IFS=: read -r name path; do
        if [ -d "$path" ]; then
            echo -e "  ${YELLOW}${name}${RST} → ${path}"
        else
            echo -e "  ${YELLOW}${name}${RST} → ${GRAY}${path} (missing)${RST}"
        fi
    done < "$MARKS_FILE"
}

remove_mark() {
    local name="$1"
    
    if [ -z "$name" ]; then
        echo -e "${RED}Error:${RST} Mark name required"
        return 1
    fi
    
    if ! grep -q "^${name}:" "$MARKS_FILE"; then
        echo -e "${RED}Error:${RST} Mark not found: ${name}"
        return 1
    fi
    
    sed -i "/^${name}:/d" "$MARKS_FILE"
    echo -e "${GREEN}✓${RST} Removed bookmark: ${YELLOW}${name}${RST}"
}

# Main command dispatcher
case "$1" in
    add)
        add_mark "$2" "$3"
        ;;
    go)
        go_mark "$2"
        ;;
    list|ls)
        list_marks
        ;;
    remove|rm)
        remove_mark "$2"
        ;;
    help|--help|-h|"")
        show_help
        ;;
    *)
        echo -e "${RED}Error:${RST} Unknown command: $1"
        echo "Use 'marks help' for usage"
        exit 1
        ;;
esac
